<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://foxssake.github.io/netfox/latest/netfox/guides/network-rollback/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>NetworkRollback - netfox</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../css/version-selector.css" rel="stylesheet" />
        <link href="../../../css/twemoji.css" rel="stylesheet" />
        <link href="../../../assets/mkdocs_puml/puml.css" rel="stylesheet" />
        <link href="../../../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "NetworkRollback";
        var mkdocs_page_input_path = "netfox/guides/network-rollback.md";
        var mkdocs_page_url = "/netfox/latest/netfox/guides/network-rollback/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script>
  <script src="https://giscus.app/client.js"
          data-repo="foxssake/netfox"
          data-repo-id="R_kgDOKBON2A"
          data-category="Docs"
          data-category-id="DIC_kwDOKBON2M4Clib_"
          data-mapping="title"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="top"
          data-theme="light"
          data-lang="en"
          data-loading="lazy"
          crossorigin="anonymous"
          async>
  </script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> netfox
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../upgrading/">Upgrading netfox</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../made-with-netfox/">Made with netfox</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../press-kit/">Press kit</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../contributors/">Contributors</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">netfox</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Tutorials</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/responsive-player-movement/">Responsive player movement</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/input-gathering-tips-and-tricks/">Input gathering tips and tricks</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/predicting-input/">Predicting input</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/modifying-objects-during-rollback/">Modifying objects during rollback</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/configuring-properties-from-code/">Configuring properties from code</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/rollback-caveats/">Rollback caveats</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../tutorials/interpolation-caveats/">Interpolation caveats</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Concepts</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../concepts/servers-clients-ownership/">Servers, clients, and ownership</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../concepts/authoritative-servers/">Authoritative servers</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Guides</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../logging/">Logging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../network-time/">NetworkTime</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../network-time-synchronizer/">NetworkTimeSynchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../network-events/">NetworkEvents</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../interpolators/">Interpolators</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../property-paths/">Property paths</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">NetworkRollback</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#network-rollback-loop">Network rollback loop</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#conditional-simulation">Conditional simulation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rollback-awareness">Rollback-awareness</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#settings">Settings</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../network-performance/">NetworkPerformance</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../visibility-management/">Visibility Management</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../netfox-sharp/">Netfox Sharp</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Nodes</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../nodes/tick-interpolator/">TickInterpolator</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../nodes/rollback-synchronizer/">RollbackSynchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../nodes/state-synchronizer/">StateSynchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../nodes/rewindable-action/">RewindableAction</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">netfox.noray</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Guides</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.noray/guides/noray/">Noray</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.noray/guides/packet-handshake/">PacketHandshake</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">netfox.extras</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Guides</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.extras/guides/physics/">Physics</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.extras/guides/base-net-input/">BaseNetInput</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.extras/guides/network-weapon/">NetworkWeapon</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.extras/guides/rewindable-state-machine/">RewindableStateMachine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.extras/guides/rewindable-random-number-generator/">RewindableRandomNumberGenerator</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.extras/guides/window-tiler/">WindowTiler</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">netfox</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">netfox</li>
          <li class="breadcrumb-item">Guides</li>
      <li class="breadcrumb-item active">NetworkRollback</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="networkrollback">NetworkRollback</h1>
<p>Orchestrates the network rollback loop. Provided as an autoload.</p>
<p>Due to latency, the server may receive inputs from clients from multiple ticks
ago. Whenever this happens, the server rewinds its time and resimulates the
whole game from the time of the new input. The resimulated ticks are then sent
to clients to update their state.</p>
<p>Also due to latency, clients may receive a state from the server that is
several ticks old. Clients rewind their simulation to the time of the latest
received state and resimulate from there.</p>
<p>On both clients and servers, simulated states are recorded for reuse later.</p>
<p>Further reading: <a href="https://www.gabrielgambetta.com/client-side-prediction-server-reconciliation.html">Client-Side Prediction and Server Reconciliation</a></p>
<p>Note that most of the time you do not need to use this class - the
<a href="../../nodes/rollback-synchronizer/">RollbackSynchronizer</a> node helps with writing rollback-aware behaviour.</p>
<h2 id="network-rollback-loop">Network rollback loop</h2>
<p><em>NetworkRollback</em> runs the <em>network rollback loop</em> after every network tick,
but before the <em>after tick</em> signal is fired.</p>
<p>The following is the network rollback loop in isolation:</p>
<div class='puml-container'><div class="puml light" style="display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="487px" preserveAspectRatio="xMidYMid meet" style="width:203px;height:487px;background:#FFFFFF;" version="1.1" viewBox="0 0 203 487" width="203px" zoomAndPan="magnify" class="diagram"><defs/><g><ellipse cx="100.7031" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="90.5176" x="55.4443" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="70.5176" x="65.4443" y="71.1387">before_loop</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="115.7539" x="42.8262" y="147.9688"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="95.7539" x="52.8262" y="169.1074">on_prepare_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="129.4063" x="36" y="201.9375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="109.4063" x="46" y="223.0762">after_prepare_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="114.9102" x="43.248" y="270.9063"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94.9102" x="53.248" y="292.0449">on_process_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="107.3398" x="47.0332" y="324.875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87.3398" x="57.0332" y="346.0137">on_record_tick</text><polygon fill="#F1F1F1" points="77.3899,103.9688,124.0164,103.9688,136.0164,115.9688,124.0164,127.9688,77.3899,127.9688,65.3899,115.9688,77.3899,103.9688" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="46.6265" x="77.3899" y="119.7769">Rollback</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80.2344" x="60.5859" y="400.8438"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60.2344" x="70.5859" y="421.9824">after_loop</text><ellipse cx="100.7031" cy="465.8125" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="100.7031" cy="465.8125" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="30" y2="50"/><polygon fill="#181818" points="96.7031,40,100.7031,50,104.7031,40,100.7031,44" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="181.9375" y2="201.9375"/><polygon fill="#181818" points="96.7031,191.9375,100.7031,201.9375,104.7031,191.9375,100.7031,195.9375" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="235.9063" y2="270.9063"/><polygon fill="#181818" points="96.7031,260.9063,100.7031,270.9063,104.7031,260.9063,100.7031,264.9063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="304.875" y2="324.875"/><polygon fill="#181818" points="96.7031,314.875,100.7031,324.875,104.7031,314.875,100.7031,318.875" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="127.9688" y2="147.9688"/><polygon fill="#181818" points="96.7031,137.9688,100.7031,147.9688,104.7031,137.9688,100.7031,141.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="358.8438" y2="368.8438"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="177.4063" y1="368.8438" y2="368.8438"/><polygon fill="#181818" points="173.4063,251.4063,177.4063,241.4063,181.4063,251.4063,177.4063,247.4063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="177.4063" x2="177.4063" y1="115.9688" y2="368.8438"/><line style="stroke:#181818;stroke-width:1;" x1="177.4063" x2="136.0164" y1="115.9688" y2="115.9688"/><polygon fill="#181818" points="146.0164,111.9688,136.0164,115.9688,146.0164,119.9688,142.0164,115.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="65.3899" x2="24" y1="115.9688" y2="115.9688"/><polygon fill="#181818" points="20,237.4063,24,247.4063,28,237.4063,24,241.4063" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="24" x2="24" y1="115.9688" y2="380.8438"/><line style="stroke:#181818;stroke-width:1;" x1="24" x2="100.7031" y1="380.8438" y2="380.8438"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="380.8438" y2="400.8438"/><polygon fill="#181818" points="96.7031,390.8438,100.7031,400.8438,104.7031,390.8438,100.7031,394.8438" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="83.9688" y2="103.9688"/><polygon fill="#181818" points="96.7031,93.9688,100.7031,103.9688,104.7031,93.9688,100.7031,97.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="100.7031" x2="100.7031" y1="434.8125" y2="454.8125"/><polygon fill="#181818" points="96.7031,444.8125,100.7031,454.8125,104.7031,444.8125,100.7031,448.8125" style="stroke:#181818;stroke-width:1;"/></g></svg></div></div>

<p>Signal handlers must implement the right steps for rollback to work.</p>
<p>During <em>before_loop</em>, all rollback-aware nodes must submit where to start the
resimulation, by calling <code>NetworkRollback.notify_resimulation_start</code>.
Resimulation will begin from the earliest tick submitted.</p>
<p>In each <em>on_prepare_tick(tick)</em> handler, nodes must rewind their state to the
specified tick. If a state is not available for the given tick, use the latest
tick that is earlier than the given tick. Nodes may also register themselves as
being simulated by calling <code>NetworkRollback.notify_simulated</code>. This is not used
by <em>NetworkRollback</em> itself, but can be used by other nodes to check which
nodes are simulated in the current rollback tick.</p>
<p>Before processing, <em>after_prepare_tick(tick)</em> is emitted. This is where any
additional state- or input preparation may happen, such as <a href="../../tutorials/predicting-input/">input prediction</a>.</p>
<p>For the <em>on_process_tick(tick)</em> signal, nodes must advance their simulation by
a single tick.</p>
<p>In <em>on_record_tick(tick)</em>, nodes must record their state for the given tick.
Note that since the simulation was advanced by one tick in the previous signal,
the <em>tick</em> parameter is incremented here.</p>
<p>The <em>after_loop</em> signal notifies its subscribers that the resimulation is done.
This can be used to change to the state that is appropriate for display.</p>
<p>The network rollback loop is part of the network tick loop as follows:</p>
<div class='puml-container'><div class="puml light" style="display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="ACTIVITY" height="835px" preserveAspectRatio="xMidYMid meet" style="width:308px;height:835px;background:#FFFFFF;" version="1.1" viewBox="0 0 308 835" width="308px" zoomAndPan="magnify" class="diagram"><defs/><g><ellipse cx="153.0947" cy="20" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="201.7578" x="52.2158" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="181.7578" x="62.2158" y="71.1387">NetworkTime.before_tick_loop</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="170.123" x="68.0332" y="159.6792"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="150.123" x="78.0332" y="180.8179">NetworkTime.before_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="146.1875" x="80.001" y="213.6479"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="126.1875" x="90.001" y="234.7866">NetworkTime.on_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="159.8398" x="73.1748" y="267.6167"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="139.8398" x="83.1748" y="288.7554">NetworkTime.after_tick</text><polygon fill="#F1F1F1" points="106.4387,103.9688,199.7507,103.9688,211.7507,115.9688,199.7507,127.9688,106.4387,127.9688,94.4387,115.9688,106.4387,103.9688" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="16.2153" x="157.0947" y="138.1792">&gt;0</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="93.312" x="106.4387" y="119.7769">Ticks to simulate</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="195.3008" x="55.4443" y="343.5854"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="175.3008" x="65.4443" y="364.7241">NetworkRollback.before_loop</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="220.5371" x="42.8262" y="441.5542"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="200.5371" x="52.8262" y="462.6929">NetworkRollback.on_prepare_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="234.1895" x="36" y="495.5229"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="214.1895" x="46" y="516.6616">NetworkRollback.after_prepare_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="219.6934" x="43.248" y="564.4917"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="199.6934" x="53.248" y="585.6304">NetworkRollback.on_process_tick</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="212.123" x="47.0332" y="618.4604"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="192.123" x="57.0332" y="639.5991">NetworkRollback.on_record_tick</text><polygon fill="#F1F1F1" points="129.7815,397.5542,176.408,397.5542,188.408,409.5542,176.408,421.5542,129.7815,421.5542,117.7815,409.5542,129.7815,397.5542" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="46.6265" x="129.7815" y="413.3623">Rollback</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="185.0176" x="60.5859" y="694.4292"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="165.0176" x="70.5859" y="715.5679">NetworkRollback.after_loop</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="191.4746" x="57.3574" y="748.3979"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="171.4746" x="67.3574" y="769.5366">NetworkTime.after_tick_loop</text><ellipse cx="153.0947" cy="813.3667" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="153.0947" cy="813.3667" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="30" y2="50"/><polygon fill="#181818" points="149.0947,40,153.0947,50,157.0947,40,153.0947,44" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="193.6479" y2="213.6479"/><polygon fill="#181818" points="149.0947,203.6479,153.0947,213.6479,157.0947,203.6479,153.0947,207.6479" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="247.6167" y2="267.6167"/><polygon fill="#181818" points="149.0947,257.6167,153.0947,267.6167,157.0947,257.6167,153.0947,261.6167" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="127.9688" y2="159.6792"/><polygon fill="#181818" points="149.0947,149.6792,153.0947,159.6792,157.0947,149.6792,153.0947,153.6792" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="301.5854" y2="311.5854"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="250.1563" y1="311.5854" y2="311.5854"/><polygon fill="#181818" points="246.1563,222.23,250.1563,212.23,254.1563,222.23,250.1563,218.23" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="250.1563" x2="250.1563" y1="115.9688" y2="311.5854"/><line style="stroke:#181818;stroke-width:1;" x1="250.1563" x2="211.7507" y1="115.9688" y2="115.9688"/><polygon fill="#181818" points="221.7507,111.9688,211.7507,115.9688,221.7507,119.9688,217.7507,115.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="94.4387" x2="56.0332" y1="115.9688" y2="115.9688"/><polygon fill="#181818" points="52.0332,208.23,56.0332,218.23,60.0332,208.23,56.0332,212.23" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="56.0332" x2="56.0332" y1="115.9688" y2="323.5854"/><line style="stroke:#181818;stroke-width:1;" x1="56.0332" x2="153.0947" y1="323.5854" y2="323.5854"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="323.5854" y2="343.5854"/><polygon fill="#181818" points="149.0947,333.5854,153.0947,343.5854,157.0947,333.5854,153.0947,337.5854" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="83.9688" y2="103.9688"/><polygon fill="#181818" points="149.0947,93.9688,153.0947,103.9688,157.0947,93.9688,153.0947,97.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="475.5229" y2="495.5229"/><polygon fill="#181818" points="149.0947,485.5229,153.0947,495.5229,157.0947,485.5229,153.0947,489.5229" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="529.4917" y2="564.4917"/><polygon fill="#181818" points="149.0947,554.4917,153.0947,564.4917,157.0947,554.4917,153.0947,558.4917" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="598.4604" y2="618.4604"/><polygon fill="#181818" points="149.0947,608.4604,153.0947,618.4604,157.0947,608.4604,153.0947,612.4604" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="421.5542" y2="441.5542"/><polygon fill="#181818" points="149.0947,431.5542,153.0947,441.5542,157.0947,431.5542,153.0947,435.5542" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="652.4292" y2="662.4292"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="282.1895" y1="662.4292" y2="662.4292"/><polygon fill="#181818" points="278.1895,544.9917,282.1895,534.9917,286.1895,544.9917,282.1895,540.9917" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="282.1895" x2="282.1895" y1="409.5542" y2="662.4292"/><line style="stroke:#181818;stroke-width:1;" x1="282.1895" x2="188.408" y1="409.5542" y2="409.5542"/><polygon fill="#181818" points="198.408,405.5542,188.408,409.5542,198.408,413.5542,194.408,409.5542" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="117.7815" x2="24" y1="409.5542" y2="409.5542"/><polygon fill="#181818" points="20,530.9917,24,540.9917,28,530.9917,24,534.9917" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="24" x2="24" y1="409.5542" y2="674.4292"/><line style="stroke:#181818;stroke-width:1;" x1="24" x2="153.0947" y1="674.4292" y2="674.4292"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="674.4292" y2="694.4292"/><polygon fill="#181818" points="149.0947,684.4292,153.0947,694.4292,157.0947,684.4292,153.0947,688.4292" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="377.5542" y2="397.5542"/><polygon fill="#181818" points="149.0947,387.5542,153.0947,397.5542,157.0947,387.5542,153.0947,391.5542" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="728.3979" y2="748.3979"/><polygon fill="#181818" points="149.0947,738.3979,153.0947,748.3979,157.0947,738.3979,153.0947,742.3979" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="153.0947" x2="153.0947" y1="782.3667" y2="802.3667"/><polygon fill="#181818" points="149.0947,792.3667,153.0947,802.3667,157.0947,792.3667,153.0947,796.3667" style="stroke:#181818;stroke-width:1;"/></g></svg></div></div>

<p>The rollback tick loop is triggered in the <code>NetworkTime.after_tick_loop</code>
signal. Since the rollback tick loop is the first thing connected to it, in
practice the rollback will run <em>before</em> any user code connected to the
<code>after_tick_loop</code> signal.</p>
<h2 id="conditional-simulation">Conditional simulation</h2>
<p>During rollback, <em>NetworkRollback</em> loops over the full range of ticks to
resimulate. Some nodes may not need to be resimulated for the current tick,
e.g. because they don't have input for the current tick.</p>
<p><em>NetworkRollback</em> can be used to track nodes that will be simulated in the
current rollback tick. Register nodes that will be simulated by calling
<code>NetworkRollback.notify_simulated</code>. To check if a node has been registered,
call <code>NetworkRollback.is_simulated</code>.</p>
<h2 id="rollback-awareness">Rollback-awareness</h2>
<p><a href="../../nodes/rollback-synchronizer/">RollbackSynchronizer</a> considers nodes rollback-aware that implement the
<code>_rollback_tick</code> method. Rollback-aware nodes are nodes that can participate in
the rollback process, i.e. they can resimulate earlier ticks.</p>
<p>To check if a node is rollback-aware, call <code>NetworkRollback.is_rollback_aware</code>.
To actually run a rollback tick on them, call
<code>NetworkRollback.process_rollback</code>.</p>
<p>These methods are called by <a href="../../nodes/rollback-synchronizer/">RollbackSynchronizer</a> under the hood.</p>
<h2 id="settings">Settings</h2>
<p><img alt="Network rollback settings" src="../../assets/network-rollback-settings.png" /></p>
<p><em>Enabled</em> toggles network rollback. No signals are fired when disabled.</p>
<p><em>History limit</em> is the maximum number of recorded ticks to keep. Larger values
enable further rewinds and thus larger latencies, but consume more memory for
each node that is recorded.</p>
<p><em>Input redundancy</em> This is the number of previous input ticks to send along with 
the current tick. We send data unreliably over UDP for speed. In the event a packet is
 lost or arrives out of order we add some redundancy. You can calculate your target
 reliability % packet success chance by using the formula 
 <code>1 - (1 - packet_success_rate) ^ input_redundancy</code>.</p>
<p><em>Display offset</em> specifies the age of the tick to display. By displaying an
older state instead of the latest one, games can mask adjustments if a state
update is received from the server. The drawback is that the game will have
some latency built-in, as it reacts to player inputs with some delay. Setting
to zero will always display the latest game state.</p>
<p><em>Input delay</em> specifies the delay applied to player input, in ticks. This
results in player inputs shifted into the future, e.g. if the player starts
moving left on tick 37, it will be sent to the server as tick 39. This way,
even if the input takes time to arrive, it will still be up to date, as long as
the network latency is smaller than the input latency.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><a href="../../nodes/rollback-synchronizer/">RollbackSynchronizer</a>'s <code>is_fresh</code> parameter may not work as expected with
input delay. This happens because clients already receive data for the
current tick, which means that the tick doesn't need to be resimulated, and
as a result, no <code>_rollback_tick</code> callbacks are ran with <code>is_fresh</code> set to
true.</p>
<p>This happens when network latency is smaller than the input delay.</p>
</div>
<p><em>Enable diff states</em> toggles diff states. By sending only state properties that
have changed, netfox can reduce the bandwidth needed to synchronize the game
between peers. See <a href="../../nodes/rollback-synchronizer/">RollbackSynchronizer</a> on how this is done and configured.</p>
              
            </div>
          </div>
  <hr>
  <h2>User discussion</h2>
  <div class="giscus" ></div>
  <hr>
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../property-paths/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../network-performance/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../assets/mkdocs_puml/puml.js"></script>
      <script src="../../../js/version-select.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
