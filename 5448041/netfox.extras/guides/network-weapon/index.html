<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://foxssake.github.io/netfox/5448041/netfox.extras/guides/network-weapon/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>NetworkWeapon - netfox</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../css/version-selector.css" rel="stylesheet" />
        <link href="../../../css/twemoji.css" rel="stylesheet" />
        <link href="../../../assets/mkdocs_puml/puml.css" rel="stylesheet" />
        <link href="../../../css/version-select.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "NetworkWeapon";
        var mkdocs_page_input_path = "netfox.extras/guides/network-weapon.md";
        var mkdocs_page_url = "/netfox/5448041/netfox.extras/guides/network-weapon/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script>
  <script src="https://giscus.app/client.js"
          data-repo="foxssake/netfox"
          data-repo-id="R_kgDOKBON2A"
          data-category="Docs"
          data-category-id="DIC_kwDOKBON2M4Clib_"
          data-mapping="title"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="top"
          data-theme="light"
          data-lang="en"
          data-loading="lazy"
          crossorigin="anonymous"
          async>
  </script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> netfox
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../upgrading/">Upgrading netfox</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../made-with-netfox/">Made with netfox</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../press-kit/">Press kit</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../contributors/">Contributors</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">netfox</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Tutorials</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/responsive-player-movement/">Responsive player movement</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/input-gathering-tips-and-tricks/">Input gathering tips and tricks</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/predicting-input/">Predicting input</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/modifying-objects-during-rollback/">Modifying objects during rollback</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/configuring-properties-from-code/">Configuring properties from code</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/rollback-caveats/">Rollback caveats</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/tutorials/interpolation-caveats/">Interpolation caveats</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Concepts</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/concepts/servers-clients-ownership/">Servers, clients, and ownership</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/concepts/authoritative-servers/">Authoritative servers</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Guides</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/logging/">Logging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/network-time/">NetworkTime</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/network-time-synchronizer/">NetworkTimeSynchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/network-events/">NetworkEvents</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/interpolators/">Interpolators</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/property-paths/">Property paths</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/network-rollback/">NetworkRollback</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/network-performance/">NetworkPerformance</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/visibility-management/">Visibility Management</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/guides/netfox-sharp/">Netfox Sharp</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Nodes</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/nodes/tick-interpolator/">TickInterpolator</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/nodes/rollback-synchronizer/">RollbackSynchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/nodes/state-synchronizer/">StateSynchronizer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox/nodes/rewindable-action/">RewindableAction</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">netfox.noray</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Guides</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.noray/guides/noray/">Noray</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../../netfox.noray/guides/packet-handshake/">PacketHandshake</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">netfox.extras</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" >Guides</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../physics/">Physics</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../network-simulator/">NetworkSimulator</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../base-net-input/">BaseNetInput</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">NetworkWeapon</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#responsive-projectiles">Responsive projectiles</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#implementing-a-weapon">Implementing a weapon</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#specializations">Specializations</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#compensating-latency">Compensating latency</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#hitscan-weapons">Hitscan weapons</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../rewindable-state-machine/">RewindableStateMachine</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../rewindable-random-number-generator/">RewindableRandomNumberGenerator</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../window-tiler/">WindowTiler</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">netfox</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">netfox.extras</li>
          <li class="breadcrumb-item">Guides</li>
      <li class="breadcrumb-item active">NetworkWeapon</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="networkweapon">NetworkWeapon</h1>
<p>Class to simplify writing networked weapons.</p>
<p>A weapon, in this context, is anything that can be fired and spawn objects (
projectiles ) upon being fired.</p>
<h2 id="responsive-projectiles">Responsive projectiles</h2>
<p>Upon firing, sending a request to the server and waiting for the response with
the projectile would introduce a delay. Doing a full-on state synchronization
with <a href="https://docs.godotengine.org/en/stable/classes/class_multiplayersynchronizer.html">MultiplayerSynchronizer</a> or <a href="../../../netfox/nodes/rollback-synchronizer/">RollbackSynchronizer</a> can be unfeasible with
too many projectiles, and unnecessary, since most of the time, projectiles act
and move the same way regardless of their surroundings.</p>
<p>Instead, upon firing, a projectile is spawned instantly. At the same time, a
request is sent to the server. If the server accepts the projectile, it will
spawn it and broadcasts its starting state. Since the server's state is the
source of truth, the projectile's local state will be updated with the
difference. This is called <em>reconciliation</em>.</p>
<p>If the client requests a projectile with an unlikely state, it will be
rejected. This is to avoid players cheating, for example by requesting
projectiles at a more advantageous position than they're at.</p>
<p>If the server is too strict with what difference is considered acceptable and
what not, legitimate players may get cases where they fire a projectile which
disappears after a short time period.</p>
<h2 id="implementing-a-weapon">Implementing a weapon</h2>
<p><em>NetworkWeapon</em> provides multiple functions to override. Make sure that all
these methods work the same way on every player's game, otherwise players will
experience glitches.</p>
<p><em>_can_fire</em> returns a bool, indicating whether the weapon can be fired. For
example, this method can return false if the weapon was fired recently and is
still on cooldown. <strong>Do not</strong> update state here. Use <em>_after_fire</em> instead.</p>
<p><em>_can_peer_use</em> indicates whether a given peer can fire the weapon. Due to the
way RPCs are set up under the hood, any of the players can try to fire a
weapon. Use this method to check if the player trying to fire has permission,
e.g. a player is not trying to use someone else's weapon.</p>
<p><em>_after_fire</em> is called after the weapon is successfully fired. Can be used to
update state ( e.g. last time the weapon was fired ) and play sound effects.</p>
<p><em>_spawn</em> creates the projectile. Make sure to return the created node.</p>
<p><em>_get_data</em> must return the projectile's starting state in a dictionary. This
can contain any property that is relevant to the projectile and must be
synchronized. For example, <em>global_transform</em> is important to ensure that the
projectile starts from the right position. On the other hand, projectile speed
does not need to be captured if it's the same for every projectile.</p>
<p><em>_apply_data</em> must apply the captured properties to a projectile.</p>
<p><em>_is_reconcilable</em> checks if the difference between two projectile states ( as
captured by <em>_get_data</em> ) is close enough to be allowed. Can be used to reject
cheating.</p>
<p><em>_reconcile</em> adjusts the projectile based on the difference between the local
and server state.</p>
<h2 id="specializations">Specializations</h2>
<p><em>NetworkWeapon</em> extends <a href="https://docs.godotengine.org/en/stable/classes/class_node.html">Node</a>. This also means that anything extending
<em>NetworkWeapon</em> is also a node, and thus can't have a position for example.</p>
<p>Two specialized classes are provided - <em>NetworkWeapon3D</em>, and <em>NetworkWeapon2D</em>
- extending Node3D and Node2D respectively.</p>
<p>This way, weapons can have transforms and have a presence in the game world.
They also take care of reconciliation, implementing <em>_get_data</em>, <em>_apply_data</em>,
<em>_is_reconcilable</em>, and <em>_reconcile</em>. These can be overridden, but make sure to
to call the base class with <em>super(...)</em>.</p>
<p>Reconciliation is based on distance, and can be configured with the
<em>distance_threshold</em> property.</p>
<p>Under the hood, these specializations create a special <em>NetworkWeapon</em> node,
that proxies all the method calls back to the specialization. This is a
workaround to build multiple inheritance in a single inheritance language.</p>
<h2 id="compensating-latency">Compensating latency</h2>
<p>Whenever the weapon is fired, it takes time for that event to arrive at the
host. To combat this, along with the weapon being fired, the firing's tick is
also sent. This way, the host doesn't only know that the weapon was fired, but
it also knows <em>when</em>.</p>
<p>To retrieve the exact tick, call <em>get_fired_tick()</em>.</p>
<p>This can be used to adjust the created projectile's simulation, e.g. by
simulating it from its spawn to the current tick in <code>_after_fire()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">func</span><span class="w"> </span><span class="n">_after_fire</span><span class="p">(</span><span class="n">projectile</span><span class="p">:</span><span class="w"> </span><span class="n">Node3D</span><span class="p">):</span>
<span class="w">    </span><span class="n">last_fire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_fired_tick</span><span class="p">()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">get_fired_tick</span><span class="p">(),</span><span class="w"> </span><span class="n">NetworkTime</span><span class="o">.</span><span class="n">tick</span><span class="p">):</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">projectile</span><span class="o">.</span><span class="n">is_queued_for_deletion</span><span class="p">():</span>
<span class="w">            </span><span class="k">break</span>
<span class="w">        </span><span class="n">projectile</span><span class="o">.</span><span class="n">_tick</span><span class="p">(</span><span class="n">NetworkTime</span><span class="o">.</span><span class="n">ticktime</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To track the tick the weapon was last fired ( e.g. for cooldowns ), make sure
to use <code>get_fired_tick()</code>, instead of <code>NetworkTime.tick</code>.</p>
</div>
<h2 id="hitscan-weapons">Hitscan weapons</h2>
<p>Use <em>NetworkWeaponHitscan3D</em> to build networked hitscan weapons. It builds upon
the same principle as <em>NetworkWeapon</em>, but modified for hitscan.</p>
<p>Most of the callbacks are the same, with the following differences:</p>
<p><em>_spawn</em> is not used, as there's no projectiles involved.</p>
<p><em>_on_fire</em> is called whenever the weapon is successfully fired. Can be used to
implement effects on firing, such as sound or visual effects.</p>
<p><em>_on_hit</em> is called whenever the weapon hits a target. Depending on
configuration, this may be another player, a different character, or just level
geometry. The raycast result is passed as a parameter to distinguish between
hits.</p>
<p>Reconciliation is handled under the hood - <em>_get_data</em>, <em>_apply_data</em>,
<em>_is_reconcilable</em>, and <em>_reconcile</em> do not need to be implemented.</p>
<p>Hitscan weapons don't implement <em>get_fired_tick()</em>, as there's no projectile to
simulate.</p>
              
            </div>
          </div>
  <hr>
  <h2>User discussion</h2>
  <div class="giscus" ></div>
  <hr>
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../base-net-input/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../rewindable-state-machine/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../assets/mkdocs_puml/puml.js"></script>
      <script src="../../../js/version-select.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
